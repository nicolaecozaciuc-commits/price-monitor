<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PriceMonitor v2.0</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f0f0f;color:#e0e0e0;font-family:sans-serif}
.animate-pulse{animation:p 2s infinite}@keyframes p{0%,100%{opacity:1}50%{opacity:.5}}
input[type="checkbox"] { accent-color: #2563eb; width: 18px; height: 18px; cursor: pointer; }
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#1a1a1a}::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
</style>
</head>
<body><div id="root"></div><script type="text/babel">
const {useState, useEffect, useRef} = React;

const Dashboard = () => {
    const [products, setProducts] = useState([]);
    const [selected, setSelected] = useState(new Set()); 
    const [checkingId, setCheckingId] = useState(null);
    const [progress, setProgress] = useState(null);
    const [targetTime, setTargetTime] = useState("02:00");
    const [autoStart, setAutoStart] = useState(false);
    const [lastRunDate, setLastRunDate] = useState(null);
    const [stats, setStats] = useState({total: 0, checked: 0, withPrice: 0});
    const stopSignal = useRef(false);

    const normalize = (str) => {
        if (!str) return "";
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");
    };

    const parseCSV = (text) => {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let inQuotes = false;
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            if (char === '"') {
                if (inQuotes && nextChar === '"') { currentCell += '"'; i++; }
                else { inQuotes = !inQuotes; }
            } else if (char === ',' && !inQuotes) {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if ((char === '\n' || char === '\r') && !inQuotes) {
                if (char === '\r' && nextChar === '\n') i++;
                currentRow.push(currentCell.trim());
                if (currentRow.length > 1 || currentRow[0] !== '') rows.push(currentRow);
                currentRow = [];
                currentCell = '';
            } else {
                currentCell += char;
            }
        }
        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
        return rows;
    };

    const parsePrice = (p) => {
        if (!p || p === '') return 0;
        let c = String(p).trim();
        if (c.includes(',') && c.indexOf(',') > c.lastIndexOf('.')) {
            c = c.replace(/\./g, '').replace(',', '.');
        } else if (c.includes(',')) {
            c = c.replace(',', '.');
        }
        const num = parseFloat(c.replace(/[^0-9.]/g, ''));
        return isNaN(num) ? 0 : num;
    };

    const findColumnIndex = (normHeaders, searchTerms, excludeTerms = []) => {
        for (const term of searchTerms) {
            const idx = normHeaders.findIndex((h) => {
                const matches = h.includes(term) || h === term;
                const excluded = excludeTerms.some(ex => h.includes(ex));
                return matches && !excluded;
            });
            if (idx !== -1) return idx;
        }
        return -1;
    };

    const handleUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const rows = parseCSV(evt.target.result);
            if (rows.length < 2) return alert("CSV Invalid sau gol");
            const headers = rows[0];
            const normHeaders = headers.map(h => normalize(h));
            console.log("=== DEBUG CSV ===");
            console.log("Headers:", headers);
            
            let iSku = findColumnIndex(normHeaders, ['sku', 'cod', 'codprodus']);
            let iName = findColumnIndex(normHeaders, ['nume', 'numeprodus', 'titlu', 'name', 'title']);
            let iPrice = findColumnIndex(normHeaders, ['pretobisnuit', 'regularprice'], ['promotional', 'promo', 'concurent']);
            if (iPrice === -1) iPrice = findColumnIndex(normHeaders, ['pret', 'price'], ['promotional', 'promo', 'concurent']);
            let iImg = findColumnIndex(normHeaders, ['imagini', 'images', 'imagine', 'poza', 'image']);
            
            console.log("Index SKU:", iSku, "Nume:", iName, "Pret:", iPrice);
            if (iSku === -1) return alert("Nu gƒÉsesc coloana SKU!");
            
            const parsed = rows.slice(1).map((r, k) => {
                if (r.length <= iSku || !r[iSku]) return null;
                let imgUrl = null;
                if (iImg !== -1 && r[iImg]) imgUrl = r[iImg].split(',')[0].trim();
                const price = (iPrice !== -1 && r[iPrice]) ? parsePrice(r[iPrice]) : 0;
                const name = (iName !== -1 && r[iName]) ? r[iName] : '';
                const sku = r[iSku].trim();
                return { id: k, sku, name, price, image: imgUrl, comps: [], lastCheck: null };
            }).filter(x => x && x.sku);
            
            console.log("Produse:", parsed.length, "Cu pre»õ:", parsed.filter(p => p.price > 0).length);
            setProducts(parsed);
            setSelected(new Set());
            setStats({total: parsed.length, checked: 0, withPrice: parsed.filter(p => p.price > 0).length});
        };
        reader.readAsText(file, 'UTF-8');
    };

    const check = async (id) => {
        const p = products.find(x => x.id === id);
        setCheckingId(id);
        try {
            const res = await fetch('/api/check', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({sku: p.sku, name: p.name, price: p.price}) 
            });
            const d = await res.json();
            if (d.status === 'success') {
                setProducts(prev => prev.map(x => x.id === id ? { ...x, comps: d.competitors, lastCheck: new Date().toLocaleTimeString() } : x));
                setStats(prev => ({...prev, checked: prev.checked + 1}));
            }
        } catch(e) { console.error(e); }
        finally { setCheckingId(null); }
    };

    const handleStop = () => { if (confirm("Opre»ôti scanarea?")) stopSignal.current = true; };
    const toggleSelect = (id) => { const newSel = new Set(selected); if (newSel.has(id)) newSel.delete(id); else newSel.add(id); setSelected(newSel); };
    const toggleAll = () => { if (selected.size === products.length) setSelected(new Set()); else setSelected(new Set(products.map(p => p.id))); };

    const runScanQueue = (queueIds) => {
        if (!queueIds.length) return alert("Nimic de scanat!");
        stopSignal.current = false;
        setProgress({cur: 0, tot: queueIds.length});
        let i = 0;
        const next = () => {
            if (stopSignal.current) { setProgress(null); setAutoStart(false); alert("üõë Scanare opritƒÉ."); return; }
            if (i >= queueIds.length) { setProgress(null); alert("‚úÖ Scanare completƒÉ!"); return; }
            setProgress({cur: i + 1, tot: queueIds.length});
            check(queueIds[i]).then(() => { i++; setTimeout(next, 5000); }); // 5s √Æntre produse (Google e lent)
        };
        next();
    };

    const runSelected = () => runScanQueue(Array.from(selected));
    const runAll = () => { if (confirm(`Scanezi toate ${products.length} produse? (Va dura ~${Math.round(products.length * 0.5)} min)`)) runScanQueue(products.map(p => p.id)); };

    const exportResults = () => {
        const checkedProducts = products.filter(p => p.comps && p.comps.length > 0);
        if (!checkedProducts.length) return alert("Nu sunt rezultate de exportat!");
        let csv = "SKU,Nume,Pret Tau,Site 1,Pret 1,Diff 1,Site 2,Pret 2,Diff 2,Site 3,Pret 3,Diff 3\n";
        checkedProducts.forEach(p => {
            csv += [
                p.sku, `"${p.name.replace(/"/g, '""')}"`, p.price,
                p.comps[0]?.name||'', p.comps[0]?.price||'', p.comps[0]?.diff ? `${p.comps[0].diff}%` : '',
                p.comps[1]?.name||'', p.comps[1]?.price||'', p.comps[1]?.diff ? `${p.comps[1].diff}%` : '',
                p.comps[2]?.name||'', p.comps[2]?.price||'', p.comps[2]?.diff ? `${p.comps[2].diff}%` : ''
            ].join(',') + '\n';
        });
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `rezultate_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    };

    useEffect(() => {
        const timer = setInterval(() => {
            if (autoStart && !progress && products.length > 0) {
                const now = new Date();
                const cur = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                if (cur === targetTime && lastRunDate !== now.toDateString()) {
                    setLastRunDate(now.toDateString());
                    runScanQueue(products.map(p => p.id));
                }
            }
        }, 1000);
        return () => clearInterval(timer);
    }, [autoStart, targetTime, products, progress, lastRunDate]);

    // Format diferen»õƒÉ cu culoare
    const DiffBadge = ({diff}) => {
        if (diff === undefined || diff === null) return null;
        const isNegative = diff < 0;
        const isPositive = diff > 0;
        const color = isNegative ? 'bg-green-600' : isPositive ? 'bg-red-600' : 'bg-gray-600';
        return (
            <span className={`${color} text-white text-[10px] px-1.5 py-0.5 rounded font-bold`}>
                {diff > 0 ? '+' : ''}{diff}%
            </span>
        );
    };

    return (
        <div className="p-4 md:p-6 max-w-[98%] mx-auto">
            <div className="bg-[#1a1a1a] p-4 md:p-6 rounded-xl border border-[#333] mb-6">
                <div className="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 className="text-xl md:text-2xl font-bold text-white flex gap-2"><span>üìä</span> PriceMonitor v2.0</h1>
                        <p className="text-gray-500 text-xs md:text-sm">Google Search + Direct Extraction ‚Ä¢ {stats.total} produse ‚Ä¢ {stats.checked} verificate</p>
                    </div>
                    <div className="flex items-center gap-2 bg-[#222] p-2 rounded-lg border border-[#444]">
                        <span className="text-gray-400 text-sm">‚è∞</span>
                        <input type="time" value={targetTime} onChange={(e) => setTargetTime(e.target.value)} className="bg-[#333] text-white px-2 py-1 rounded border border-[#555] text-sm w-24" disabled={autoStart}/>
                        <button onClick={() => setAutoStart(!autoStart)} className={`px-3 py-1 rounded text-xs font-bold transition ${autoStart ? 'bg-green-600 text-white animate-pulse' : 'bg-gray-600 text-gray-300 hover:bg-gray-500'}`}>{autoStart ? 'ON' : 'OFF'}</button>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                        {progress ? (
                            <div className="flex items-center gap-3">
                                <span className="text-blue-400 font-mono animate-pulse">{progress.cur}/{progress.tot}</span>
                                <button onClick={handleStop} className="bg-red-600 px-4 py-2 rounded text-white font-bold hover:bg-red-700 border border-red-500">üõë STOP</button>
                            </div>
                        ) : (
                            <>
                                <label className="bg-[#333] px-4 py-2 rounded cursor-pointer hover:bg-[#444] text-white border border-[#555] text-sm font-bold transition">üìÇ CSV<input type="file" accept=".csv" onChange={handleUpload} className="hidden"/></label>
                                {selected.size > 0 && <button onClick={runSelected} className="bg-green-600 px-4 py-2 rounded text-white font-bold hover:bg-green-700 border border-green-500">‚úÖ ScaneazƒÉ {selected.size}</button>}
                                <button onClick={runAll} disabled={!products.length} className="bg-blue-600 px-4 py-2 rounded text-white font-bold hover:bg-blue-700 disabled:opacity-50 border border-blue-500 transition">üöÄ ScaneazƒÉ TOT</button>
                                {products.some(p => p.comps?.length > 0) && <button onClick={exportResults} className="bg-purple-600 px-4 py-2 rounded text-white font-bold hover:bg-purple-700 border border-purple-500 transition">üì• Export</button>}
                            </>
                        )}
                    </div>
                </div>
            </div>

            <div className="bg-[#1a1a1a] rounded-xl border border-[#333] overflow-x-auto">
                <table className="w-full text-left text-sm text-gray-300">
                    <thead className="bg-black text-gray-500 uppercase text-xs">
                        <tr>
                            <th className="p-3 w-12 text-center"><input type="checkbox" onChange={toggleAll} checked={products.length > 0 && selected.size === products.length}/></th>
                            <th className="p-3">PRODUS</th>
                            <th className="p-3 w-28">PRE»öUL TƒÇU</th>
                            <th className="p-3">CONCUREN»öƒÇ (Google + Direct)</th>
                            <th className="p-3 w-20 text-center">AC»öIUNI</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-[#2a2a2a]">
                        {products.length === 0 ? (
                            <tr><td colSpan="5" className="p-8 text-center text-gray-500">üìÇ √éncarcƒÉ un fi»ôier CSV pentru a √Æncepe</td></tr>
                        ) : products.map(p => {
                            const minCompPrice = p.comps?.length > 0 ? Math.min(...p.comps.map(c => c.price)) : null;
                            const isCheaperThanAll = minCompPrice && p.price > 0 && p.price <= minCompPrice;
                            return (
                                <tr key={p.id} className={`hover:bg-[#222] transition ${selected.has(p.id) ? 'bg-[#2a2a35]' : ''} ${checkingId === p.id ? 'bg-blue-900/20' : ''}`}>
                                    <td className="p-3 text-center"><input type="checkbox" checked={selected.has(p.id)} onChange={() => toggleSelect(p.id)}/></td>
                                    <td className="p-3">
                                        <div className="flex items-start gap-3">
                                            <div className="w-14 h-14 bg-white rounded flex items-center justify-center overflow-hidden border border-gray-600 shrink-0">
                                                {p.image ? <img src={p.image} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'}/> : <span className="text-xl">üì¶</span>}
                                            </div>
                                            <div className="min-w-0">
                                                <div className="font-bold text-white text-sm truncate max-w-xs" title={p.name}>{p.name || 'FƒÉrƒÉ nume'}</div>
                                                <div className="text-xs bg-[#333] px-2 py-0.5 rounded inline-block font-mono text-gray-400 mt-1">{p.sku}</div>
                                                {p.lastCheck && <div className="text-[10px] text-green-400 mt-1">‚úì {p.lastCheck}</div>}
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-3"><span className={`text-lg font-bold ${isCheaperThanAll ? 'text-green-400' : 'text-emerald-400'}`}>{p.price > 0 ? `${p.price.toLocaleString('ro-RO')} Lei` : '-'}</span></td>
                                    <td className="p-3">
                                        {p.comps && p.comps.length > 0 ? (
                                            <div className="flex flex-wrap gap-2">
                                                {p.comps.map((c, k) => {
                                                    const isCheaper = p.price > 0 && c.price < p.price;
                                                    const isLowest = c.price === minCompPrice;
                                                    return (
                                                        <div key={k} className={`p-2 rounded border min-w-[120px] ${isCheaper ? 'bg-red-900/30 border-red-700' : 'bg-green-900/20 border-green-800'} ${isLowest ? 'ring-2 ring-yellow-500' : ''}`}>
                                                            <div className="flex justify-between items-start gap-2">
                                                                <span className="font-bold text-xs text-gray-400 truncate max-w-[80px]" title={c.name}>{c.name}</span>
                                                                <DiffBadge diff={c.diff} />
                                                            </div>
                                                            <div className={`text-lg font-bold ${isCheaper ? 'text-red-400' : 'text-green-400'}`}>
                                                                {c.price.toLocaleString('ro-RO')} <span className="text-xs">Lei</span>
                                                            </div>
                                                            <a href={c.url} target="_blank" rel="noopener noreferrer" className="text-[10px] text-blue-400 hover:underline block truncate" title={c.url}>üîó vezi oferta</a>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ) : checkingId === p.id ? (
                                            <span className="text-blue-400 text-xs animate-pulse">‚è≥ Scanare Google...</span>
                                        ) : (
                                            <span className="text-gray-600 text-xs">‚Äî</span>
                                        )}
                                    </td>
                                    <td className="p-3 text-center"><button onClick={() => check(p.id)} disabled={checkingId === p.id} className="text-blue-400 border border-blue-900/50 hover:bg-blue-900/30 px-3 py-2 rounded transition disabled:opacity-50">{checkingId === p.id ? '‚è≥' : 'üîç'}</button></td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Dashboard />);
</script></body></html>
