<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitor v8 - Dark Edition</title>
    
    <!-- LibrƒÉrii React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Scrollbar Dark */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- PARSER CSV UNIVERSAL ---
        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ''; let inQuote = false;
            const cleanText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            for (let i = 0; i < cleanText.length; i++) {
                const char = cleanText[i];
                if (char === '"') {
                    if (inQuote && cleanText[i+1] === '"') { currentCell += '"'; i++; }
                    else { inQuote = !inQuote; }
                } else if (char === ',' && !inQuote) {
                    currentRow.push(currentCell); currentCell = '';
                } else if (char === '\n' && !inQuote) {
                    currentRow.push(currentCell); rows.push(currentRow); currentRow = []; currentCell = '';
                } else { currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell); rows.push(currentRow); }
            return rows;
        };

        const parsePrice = (p) => {
            if (!p) return 0;
            let c = String(p).trim();
            // Format RO: 7.999,00 -> 7999.00
            if (c.includes(',') && c.indexOf(',') > c.lastIndexOf('.')) c = c.replace(/\./g, '').replace(',', '.');
            else if (c.includes(',')) c = c.replace(',', '.');
            return parseFloat(c.replace(/[^0-9.]/g, '')) || 0;
        };

        const normalize = (h) => h ? h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : "";

        // --- DASHBOARD UI DARK ---
        const Dashboard = () => {
            const [products, setProducts] = useState([]);
            const [checkingIds, setCheckingIds] = useState(new Set());
            const [bulkProgress, setBulkProgress] = useState(null);

            const handleCheckPrice = async (id) => {
                const p = products.find(x => x.id === id);
                if (!p) return;
                setCheckingIds(prev => new Set(prev).add(id));
                try {
                    const res = await fetch('/api/check', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ sku: p.sku, name: p.name })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setProducts(prev => prev.map(prod => prod.id === id ? { ...prod, competitors: data.competitors } : prod));
                    }
                } catch (e) { console.error(e); } 
                finally {
                    setCheckingIds(prev => { const n = new Set(prev); n.delete(id); return n; });
                    if(bulkProgress) setBulkProgress(prev => prev ? { ...prev, current: prev.current + 1 } : null);
                }
            };

            const handleBulk = () => {
                if (products.length === 0) return alert("√éncarcƒÉ CSV!");
                if (confirm(`Verifici ${products.length} produse REAL?`)) {
                    setBulkProgress({ current: 0, total: products.length });
                    let i = 0;
                    const next = () => {
                        if (i >= products.length) { setBulkProgress(null); return; }
                        handleCheckPrice(products[i].id).then(() => { i++; setTimeout(next, 3000); });
                    };
                    next();
                }
            };

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const rows = parseCSV(evt.target.result);
                    if (rows.length < 2) return alert("CSV invalid");
                    
                    const headers = rows[0];
                    const normHeaders = headers.map(h => normalize(h));
                    
                    let idxSku = normHeaders.findIndex(h => h.includes('sku'));
                    let idxName = normHeaders.findIndex(h => h.includes('nume'));
                    let idxPrice = normHeaders.indexOf('pretnostru');
                    if (idxPrice === -1) idxPrice = normHeaders.findIndex(h => h.includes('pretobisnuit'));
                    if (idxPrice === -1) idxPrice = normHeaders.findIndex(h => h.includes('pret') && !h.includes('concurent'));

                    if (idxSku === -1 || idxPrice === -1) return alert("Nu gƒÉsesc SKU sau Pre»õ.");

                    setProducts(rows.slice(1).map((row, i) => {
                        if (row.length <= idxSku) return null;
                        return {
                            id: Date.now() + i,
                            name: row[idxName] || "",
                            sku: row[idxSku],
                            price: parsePrice(row[idxPrice]),
                            competitors: []
                        };
                    }).filter(p => p && p.sku));
                };
                reader.readAsText(file);
            };

            const handleExport = () => {
                let csv = "SKU,Nume,Pret Nostru,Pret Concurent (Min),Link\n";
                products.forEach(p => {
                    const minComp = p.competitors.length > 0 ? p.competitors[0] : null;
                    csv += `"${p.sku}","${p.name}",${p.price},${minComp ? minComp.price : ""},${minComp ? minComp.url : ""}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = "rezultate_v8.csv"; a.click();
            };

            return (
                <div className="min-h-screen bg-[#0f0f0f] text-gray-200 font-sans p-6">
                    {/* Header Card */}
                    <div className="flex justify-between items-center mb-8 bg-[#1a1a1a] p-6 rounded-xl border border-[#2a2a2a] shadow-lg">
                        <div>
                            <div className="text-2xl font-bold text-white flex items-center gap-3">
                                <span className="bg-gradient-to-r from-indigo-500 to-purple-600 text-transparent bg-clip-text">üìä</span> 
                                PriceMonitor v8
                            </div>
                            <div className="text-gray-500 text-sm mt-1">Interfa»õƒÉ Dark Mode ‚Ä¢ Motor Real</div>
                        </div>
                        <div className="flex gap-3 items-center">
                            {bulkProgress && (
                                <div className="bg-blue-900/30 text-blue-300 px-4 py-2 rounded-lg border border-blue-500/30 flex items-center gap-2 animate-pulse">
                                    <div className="text-xl">‚öôÔ∏è</div>
                                    <div>
                                        <div className="text-xs font-bold uppercase">Progres</div>
                                        <div className="font-mono">{bulkProgress.current} / {bulkProgress.total}</div>
                                    </div>
                                </div>
                            )}
                            <button onClick={handleBulk} disabled={!!bulkProgress} className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-3 rounded-lg text-white font-bold hover:from-indigo-700 hover:to-purple-700 transition shadow-lg shadow-indigo-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                                {bulkProgress ? '‚è≥ Se lucreazƒÉ...' : 'üöÄ Start Scanare'}
                            </button>
                            {products.length > 0 && <button onClick={handleExport} className="bg-emerald-600 px-6 py-3 rounded-lg text-white font-bold hover:bg-emerald-700 transition shadow-lg">üì• Export</button>}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* Sidebar */}
                        <div className="space-y-4">
                            <div className="bg-[#1a1a1a] p-5 rounded-xl border border-[#2a2a2a]">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-4 flex items-center gap-2">
                                    <span>üìÅ</span> Import Date
                                </h3>
                                <label className="block w-full cursor-pointer bg-[#252525] hover:bg-[#2a2a2a] border border-dashed border-gray-600 rounded-lg p-8 text-center transition group">
                                    <div className="text-3xl mb-2 group-hover:scale-110 transition">üìÑ</div>
                                    <div className="text-sm text-gray-400 group-hover:text-white">Click pentru a √ÆncƒÉrca CSV</div>
                                    <input type="file" accept=".csv" onChange={handleUpload} className="hidden"/>
                                </label>
                            </div>
                            
                            <div className="bg-[#1a1a1a] p-5 rounded-xl border border-[#2a2a2a]">
                                <div className="text-gray-500 text-xs font-bold uppercase mb-2">Statistici</div>
                                <div className="flex justify-between items-center mb-2">
                                    <span>Total Produse:</span>
                                    <span className="text-white font-bold">{products.length}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span>Scanate:</span>
                                    <span className="text-indigo-400 font-bold">{products.filter(p => p.competitors.length > 0).length}</span>
                                </div>
                            </div>
                        </div>

                        {/* Main Table */}
                        <div className="lg:col-span-3 bg-[#1a1a1a] rounded-xl border border-[#2a2a2a] overflow-hidden shadow-xl">
                            <table className="w-full text-left text-sm text-gray-300">
                                <thead className="bg-[#111] text-gray-500 uppercase text-xs">
                                    <tr>
                                        <th className="p-4">Produs / SKU</th>
                                        <th className="p-4">Pre»õ TƒÉu</th>
                                        <th className="p-4">Concuren»õƒÉ (Google)</th>
                                        <th className="p-4 text-right">Ac»õiuni</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-[#2a2a2a]">
                                    {products.map(p => (
                                        <tr key={p.id} className="hover:bg-[#222] transition">
                                            <td className="p-4 align-top">
                                                <div className="font-bold text-gray-200 text-base">{p.name}</div>
                                                <div className="text-xs text-gray-500 font-mono mt-1 bg-black/30 inline-block px-2 py-1 rounded border border-[#333]">{p.sku}</div>
                                            </td>
                                            <td className="p-4 align-top">
                                                <div className="font-bold text-emerald-400 text-lg">{p.price} Lei</div>
                                            </td>
                                            <td className="p-4 align-top">
                                                {p.competitors.length > 0 ? (
                                                    <div className="space-y-2 animate-fadeIn">
                                                        {p.competitors.map((c, i) => (
                                                            <div key={i} className="flex items-center justify-between text-xs bg-black/20 p-2 rounded border border-[#333] hover:border-[#555] transition">
                                                                <div className="flex items-center gap-2">
                                                                    <div className={`w-2 h-2 rounded-full ${c.price < p.price ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                                                    <a href={c.url} target="_blank" className="text-indigo-400 hover:text-indigo-300 hover:underline font-medium">{c.name}</a>
                                                                </div>
                                                                <span className={c.price < p.price ? 'text-red-400 font-bold' : 'text-green-400 font-bold'}>{c.price} Lei</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : <span className="text-gray-600 text-xs italic">...</span>}
                                            </td>
                                            <td className="p-4 text-right align-top">
                                                <button onClick={() => handleCheckPrice(p.id)} className="text-indigo-400 hover:bg-indigo-900/30 border border-indigo-500/30 hover:border-indigo-500/50 px-3 py-1.5 rounded transition">
                                                    {checkingIds.has(p.id) ? <span className="animate-spin inline-block">‚Üª</span> : 'üîç VerificƒÉ'}
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
