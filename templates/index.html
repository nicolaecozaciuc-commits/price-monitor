<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitor - Professional</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- PARSER CSV AVANSAT (RezolvƒÉ problema 'Pre»õ 0') ---
        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ''; let inQuote = false;
            const cleanText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            for (let i = 0; i < cleanText.length; i++) {
                const char = cleanText[i];
                if (char === '"') {
                    if (inQuote && cleanText[i+1] === '"') { currentCell += '"'; i++; }
                    else { inQuote = !inQuote; }
                } else if (char === ',' && !inQuote) {
                    currentRow.push(currentCell); currentCell = '';
                } else if (char === '\n' && !inQuote) {
                    currentRow.push(currentCell); rows.push(currentRow); currentRow = []; currentCell = '';
                } else { currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell); rows.push(currentRow); }
            return rows;
        };

        const parsePrice = (p) => {
            if (!p) return 0;
            let c = String(p).trim();
            // Format RO (1.200,00) -> 1200.00
            if (c.includes(',') && c.indexOf(',') > c.lastIndexOf('.')) c = c.replace(/\./g, '').replace(',', '.');
            else if (c.includes(',')) c = c.replace(',', '.');
            return parseFloat(c.replace(/[^0-9.]/g, '')) || 0;
        };

        const normalize = (h) => h ? h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : "";

        // --- COMPONENTA PRINCIPALƒÇ ---
        const Dashboard = () => {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(null); // Stare pentru bara de progres

            // Verificare produs individual
            const checkProduct = async (id) => {
                const p = products.find(x => x.id === id);
                if (!p) return;

                // Marcare ca "se verificƒÉ" (vizual)
                setProducts(prev => prev.map(x => x.id === id ? {...x, checking: true} : x));

                try {
                    const res = await fetch('/api/check', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ sku: p.sku, name: p.name })
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        setProducts(prev => prev.map(x => x.id === id ? { 
                            ...x, 
                            competitors: data.competitors, 
                            checking: false,
                            lastCheck: new Date().toLocaleTimeString() 
                        } : x));
                    }
                } catch (e) {
                    console.error("Eroare API:", e);
                    setProducts(prev => prev.map(x => x.id === id ? {...x, checking: false} : x));
                }
            };

            // Verificare √Æn masƒÉ
            const runBulkCheck = () => {
                if (products.length === 0) return alert("√éncarcƒÉ mai √Ænt√¢i un fi»ôier CSV!");
                if (!confirm(`Vrei sƒÉ verifici ${products.length} produse? Va dura ceva timp.`)) return;

                setLoading({ current: 0, total: products.length });
                let i = 0;

                const processNext = () => {
                    if (i >= products.length) {
                        setLoading(null);
                        alert("Verificare finalizatƒÉ!");
                        return;
                    }
                    
                    // Actualizare progres
                    setLoading({ current: i + 1, total: products.length });
                    
                    checkProduct(products[i].id).then(() => {
                        i++;
                        // PauzƒÉ de siguran»õƒÉ √Æntre cereri (2 secunde)
                        setTimeout(processNext, 2000);
                    });
                };
                processNext();
            };

            // Import CSV
            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const rows = parseCSV(evt.target.result);
                    if (rows.length < 2) return alert("Fi»ôier invalid sau gol.");
                    
                    const headers = rows[0];
                    const normHeaders = headers.map(h => normalize(h));
                    
                    // Detec»õie coloane
                    let idxSku = normHeaders.findIndex(h => h.includes('sku'));
                    let idxName = normHeaders.findIndex(h => h.includes('nume') || h.includes('titlu'));
                    
                    // LogicƒÉ pre»õ (Prioritate: Pret Nostru > Pret Obisnuit > Pret)
                    let idxPrice = normHeaders.indexOf('pretnostru');
                    if (idxPrice === -1) idxPrice = normHeaders.findIndex(h => h.includes('pretobisnuit'));
                    if (idxPrice === -1) idxPrice = normHeaders.findIndex(h => h.includes('pret') && !h.includes('concurent'));

                    if (idxSku === -1 || idxPrice === -1) 
                        return alert(`Coloane lipsƒÉ! AsigurƒÉ-te cƒÉ ai 'SKU' »ôi 'Pre»õ' √Æn CSV.\nGƒÉsite: ${headers.join(', ')}`);

                    const newProds = rows.slice(1).map((row, i) => {
                        if (row.length <= idxSku) return null;
                        return {
                            id: Date.now() + i,
                            name: row[idxName] || "FƒÉrƒÉ Nume",
                            sku: row[idxSku],
                            price: parsePrice(row[idxPrice]),
                            competitors: [],
                            checking: false
                        };
                    }).filter(p => p && p.sku); // EliminƒÉ r√¢ndurile goale

                    setProducts(newProds);
                };
                reader.readAsText(file);
            };

            // Export CSV
            const handleExport = () => {
                let csv = "SKU,Nume,Pret Nostru,Pret Concurent (Min),Link\n";
                products.forEach(p => {
                    const minComp = p.competitors.length > 0 ? p.competitors[0] : null;
                    csv += `"${p.sku}","${p.name}",${p.price},${minComp ? minComp.price : ""},${minComp ? minComp.url : ""}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = "rezultate_preturi.csv"; a.click();
            };

            return (
                <div className="container mx-auto px-4 py-8">
                    {/* HEADER */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <span className="text-blue-600">üìä</span> PriceMonitor
                            </h1>
                            <p className="text-sm text-gray-500">Versiune Clean & Real (v9.0)</p>
                        </div>
                        
                        <div className="flex gap-3">
                            <label className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md cursor-pointer border border-gray-300 transition font-medium text-sm">
                                üìÇ Import CSV
                                <input type="file" accept=".csv" onChange={handleUpload} className="hidden" />
                            </label>
                            
                            <button 
                                onClick={runBulkCheck} 
                                disabled={!!loading || products.length === 0}
                                className={`px-4 py-2 rounded-md text-white font-medium text-sm transition shadow-sm
                                    ${loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                {loading ? `‚è≥ Progres: ${loading.current}/${loading.total}` : 'üöÄ Start Scanare'}
                            </button>

                            {products.length > 0 && (
                                <button onClick={handleExport} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium text-sm shadow-sm">
                                    üì• Export
                                </button>
                            )}
                        </div>
                    </div>

                    {/* TABLE */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 text-gray-600 uppercase text-xs font-semibold tracking-wider">
                                <tr>
                                    <th className="p-4 border-b border-gray-200">Produs / SKU</th>
                                    <th className="p-4 border-b border-gray-200 w-32">Pre»õ TƒÉu</th>
                                    <th className="p-4 border-b border-gray-200">Concuren»õƒÉ (Google)</th>
                                    <th className="p-4 border-b border-gray-200 w-24 text-right">Ac»õiuni</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 text-sm">
                                {products.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="p-12 text-center text-gray-400 italic">
                                            Niciun produs √ÆncƒÉrcat. Folose»ôte butonul "Import CSV".
                                        </td>
                                    </tr>
                                ) : products.map(p => (
                                    <tr key={p.id} className="hover:bg-blue-50 transition-colors">
                                        <td className="p-4 align-top">
                                            <div className="font-medium text-gray-900">{p.name}</div>
                                            <div className="text-xs text-gray-500 font-mono mt-1 bg-gray-100 inline-block px-1.5 py-0.5 rounded border border-gray-200">
                                                {p.sku}
                                            </div>
                                        </td>
                                        <td className="p-4 align-top">
                                            <div className="font-bold text-gray-800">{p.price} Lei</div>
                                        </td>
                                        <td className="p-4 align-top">
                                            {p.competitors.length > 0 ? (
                                                <div className="space-y-1.5">
                                                    {p.competitors.map((c, idx) => {
                                                        const isCheaper = c.price < p.price;
                                                        return (
                                                            <div key={idx} className={`flex items-center justify-between px-2 py-1 rounded text-xs border ${isCheaper ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'}`}>
                                                                <a href={c.url} target="_blank" className="text-blue-600 hover:underline truncate max-w-[200px] font-medium">
                                                                    {c.name}
                                                                </a>
                                                                <span className={isCheaper ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}>
                                                                    {c.price} Lei
                                                                </span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ) : (
                                                <span className="text-gray-400 italic text-xs">
                                                    {p.checking ? "Se cautƒÉ..." : "Nicio verificare"}
                                                </span>
                                            )}
                                        </td>
                                        <td className="p-4 text-right align-top">
                                            <button 
                                                onClick={() => checkProduct(p.id)} 
                                                disabled={p.checking}
                                                className="text-gray-500 hover:text-blue-600 disabled:opacity-50 transition"
                                                title="VerificƒÉ acest produs"
                                            >
                                                {p.checking ? <span className="animate-spin inline-block">‚Üª</span> : 'üîç'}
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
