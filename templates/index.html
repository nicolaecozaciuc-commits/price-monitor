<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Price Monitor v13.4</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f0f0f;color:#e0e0e0;font-family:sans-serif}
.animate-pulse{animation:p 2s infinite}@keyframes p{0%,100%{opacity:1}50%{opacity:.5}}
input[type="checkbox"] { accent-color: #2563eb; width: 18px; height: 18px; cursor: pointer; }
.row-highlight { animation: highlight 2s ease-out; }
@keyframes highlight { 0% { background-color: #1e3a8a; } 100% { background-color: transparent; } }
</style>
</head>
<body><div id="root"></div><script type="text/babel">
const {useState, useEffect, useRef} = React;

const Dashboard = () => {
    const [products, setProducts] = useState([]);
    const [selected, setSelected] = useState(new Set()); 
    const [checkingId, setCheckingId] = useState(null);
    const [progress, setProgress] = useState(null);
    const [targetTime, setTargetTime] = useState("02:00");
    const [autoStart, setAutoStart] = useState(false);
    const [lastRunDate, setLastRunDate] = useState(null);
    const stopSignal = useRef(false);

    // CSV PARSER
    const parseCSV = (text) => {
        const rows = []; let cur = []; let cell = ''; let q = false;
        text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('').forEach(c => {
            if(c === '"') q = !q; else if(c === ',' && !q) { cur.push(cell); cell = ''; }
            else if(c === '\n' && !q) { cur.push(cell); rows.push(cur); cur = []; cell = ''; }
            else cell += c;
        });
        if(cell || cur.length) { cur.push(cell); rows.push(cur); }
        return rows;
    };

    const parsePrice = (p) => {
        if (!p) return 0;
        let c = String(p).trim();
        if (c.includes(',') && c.indexOf(',') > c.lastIndexOf('.')) c = c.replace(/\./g, '').replace(',', '.');
        else if (c.includes(',')) c = c.replace(',', '.');
        return parseFloat(c.replace(/[^0-9.]/g, '')) || 0;
    };

    const handleUpload = (e) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const rows = parseCSV(evt.target.result);
            if(rows.length < 2) return alert("CSV Invalid");
            const h = rows[0].map(x => x.toLowerCase().replace(/[^a-z0-9]/g, ''));
            
            let iSku = h.findIndex(x => x.includes('sku'));
            let iName = h.findIndex(x => x.includes('nume'));
            let iPrice = h.indexOf('pretnostru');
            if(iPrice === -1) iPrice = h.findIndex(x => x.includes('pretobisnuit') || (x.includes('pret') && !x.includes('concurent')));
            let iImg = h.findIndex(x => x.includes('imagini') || x.includes('images') || x.includes('poza'));

            if(iSku === -1) return alert("Nu gasesc SKU");
            
            setProducts(rows.slice(1).map((r, k) => {
                if(r.length <= iSku) return null;
                let imgUrl = null;
                if (iImg !== -1 && r[iImg]) imgUrl = r[iImg].split(',')[0].trim();
                let finalPrice = iPrice !== -1 && r[iPrice] ? parsePrice(r[iPrice]) : 0;

                return {
                    id: k, 
                    sku: r[iSku], 
                    name: r[iName]||'', 
                    price: finalPrice, 
                    image: imgUrl, 
                    comps: [],
                    lastCheck: null,
                    status: 'pending' // pending, found, no_results
                };
            }).filter(x => x && x.sku));
        };
        reader.readAsText(e.target.files[0]);
    };

    const check = async (id) => {
        const p = products.find(x => x.id === id);
        setCheckingId(id);
        try {
            const res = await fetch('/api/check', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)});
            const d = await res.json();
            if(d.status === 'success') {
                setProducts(prev => prev.map(x => {
                    if (x.id === id) {
                        return {
                            ...x, 
                            comps: d.competitors,
                            lastCheck: new Date().toLocaleTimeString(),
                            status: d.competitors.length > 0 ? 'found' : 'no_results'
                        };
                    }
                    return x;
                }));
            }
        } catch(e) { console.error(e); }
        finally { setCheckingId(null); }
    };

    const handleStop = () => { 
        if(confirm("Opre»ôti scanarea? Vom afi»ôa rezultatele culese p√¢nƒÉ acum.")) {
            stopSignal.current = true; 
        }
    };

    const toggleSelect = (id) => {
        const newSel = new Set(selected);
        if(newSel.has(id)) newSel.delete(id); else newSel.add(id);
        setSelected(newSel);
    };

    const toggleAll = () => {
        if(selected.size === products.length) setSelected(new Set());
        else setSelected(new Set(products.map(p => p.id)));
    };

    // Func»õie pentru analiza finalƒÉ (se apeleazƒÉ la Stop sau Finish)
    const finalizeScan = () => {
        setProgress(null); 
        setAutoStart(false);
        
        // Calcul statistici
        const scanned = products.filter(p => p.status === 'found' || p.status === 'no_results');
        const problematic = scanned.filter(p => p.comps.some(c => c.price < p.price));
        
        if (scanned.length > 0) {
            // Sortare automatƒÉ: cele cu probleme (concurent mai ieftin) primele
            const sorted = [...products].sort((a, b) => {
                const aCheap = a.comps.some(c => c.price < a.price);
                const bCheap = b.comps.some(c => c.price < b.price);
                if (aCheap && !bCheap) return -1;
                if (!aCheap && bCheap) return 1;
                return 0;
            });
            setProducts(sorted);
            alert(`üõë Scanare √éncheiatƒÉ!\n\nProduse verificate: ${scanned.length}\nProduse unde e»ôti mai scump: ${problematic.length}\n\nLista a fost reordonatƒÉ pentru a arƒÉta prioritƒÉ»õile.`);
        } else {
            alert("üõë Scanare opritƒÉ.");
        }
    };

    const runScanQueue = (queueIds) => {
        if(!queueIds.length) return alert("Nimic de scanat!");
        stopSignal.current = false;
        setProgress({cur:0, tot:queueIds.length});
        
        let i = 0;
        const next = () => {
            if (stopSignal.current) { 
                finalizeScan();
                return; 
            }
            if(i >= queueIds.length) { 
                alert("‚úÖ Scanare completƒÉ!");
                finalizeScan();
                return; 
            }
            
            setProgress({cur:i+1, tot:queueIds.length});
            check(queueIds[i]).then(() => { 
                i++; setTimeout(next, 2000); 
            });
        };
        next();
    };

    const runSelected = () => runScanQueue(Array.from(selected));
    const runAll = () => { if(confirm("Scanezi TOT?")) runScanQueue(products.map(p => p.id)); };

    useEffect(() => {
        const timer = setInterval(() => {
            if (autoStart && !progress && products.length > 0) {
                const now = new Date();
                const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                if (cur === targetTime && lastRunDate !== now.toDateString()) {
                    setLastRunDate(now.toDateString());
                    runScanQueue(products.map(p => p.id));
                }
            }
        }, 1000);
        return () => clearInterval(timer);
    }, [autoStart, targetTime, products, progress, lastRunDate]);

    return (
        <div className="p-6 max-w-[95%] mx-auto">
            <div className="bg-[#1a1a1a] p-6 rounded-xl border border-[#333] mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-white flex gap-2"><span>üìä</span> PriceMonitor v13.4</h1>
                    <p className="text-gray-500 text-sm">Sortare AutomatƒÉ la Stop ‚Ä¢ Imagini ‚Ä¢ Feedback</p>
                </div>
                <div className="flex items-center gap-3 bg-[#222] p-2 rounded-lg border border-[#444]">
                    <span className="text-gray-400 text-sm">‚è∞</span>
                    <input type="time" value={targetTime} onChange={(e) => setTargetTime(e.target.value)} className="bg-[#333] text-white px-2 py-1 rounded border border-[#555] text-sm" disabled={autoStart}/>
                    <button onClick={() => setAutoStart(!autoStart)} className={`px-3 py-1 rounded text-xs font-bold ${autoStart ? 'bg-green-600 text-white animate-pulse' : 'bg-gray-600 text-gray-300'}`}>{autoStart ? 'ON' : 'OFF'}</button>
                </div>
                <div className="flex gap-3">
                    {progress ? (
                        <div className="flex items-center gap-3">
                            <span className="text-blue-400 font-mono animate-pulse">Progres: {progress.cur}/{progress.tot}</span>
                            <button onClick={handleStop} className="bg-red-600 px-6 py-2 rounded text-white font-bold hover:bg-red-700 border border-red-500">üõë STOP & REZULTATE</button>
                        </div>
                    ) : (
                        <div className="flex gap-3 items-center">
                            <label className="bg-[#333] px-4 py-2 rounded cursor-pointer hover:bg-[#444] text-white border border-[#555] text-sm font-bold">üìÇ CSV <input type="file" onChange={handleUpload} className="hidden"/></label>
                            {selected.size > 0 ? (
                                <button onClick={runSelected} className="bg-green-600 px-4 py-2 rounded text-white font-bold hover:bg-green-700 shadow-lg border border-green-500 animate-pulse">‚úÖ ScaneazƒÉ {selected.size} Selectate</button>
                            ) : (
                                <button onClick={runAll} disabled={!products.length} className="bg-blue-600 px-4 py-2 rounded text-white font-bold hover:bg-blue-700 disabled:opacity-50 border border-blue-500">üöÄ ScaneazƒÉ TOT</button>
                            )}
                        </div>
                    )}
                </div>
            </div>
            <div className="bg-[#1a1a1a] rounded-xl border border-[#333] overflow-hidden">
                <table className="w-full text-left text-sm text-gray-300">
                    <thead className="bg-black text-gray-500 uppercase">
                        <tr>
                            <th className="p-4 w-12 text-center"><input type="checkbox" onChange={toggleAll} checked={products.length > 0 && selected.size === products.length} /></th>
                            <th className="p-4 w-1/4">Produs</th>
                            <th className="p-4 w-32">Pre»õul TƒÉu</th>
                            <th className="p-4">Concuren»õƒÉ (Direct)</th>
                            <th className="p-4 w-24">Ac»õiuni</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-[#2a2a2a]">
                        {products.map(p => (
                            <tr key={p.id} className={`hover:bg-[#222] ${selected.has(p.id) ? 'bg-[#2a2a35]' : ''} ${checkingId === p.id ? 'bg-blue-900/10' : ''}`}>
                                <td className="p-4 text-center"><input type="checkbox" checked={selected.has(p.id)} onChange={() => toggleSelect(p.id)} /></td>
                                <td className="p-4 align-top">
                                    <div className="flex items-start gap-3">
                                        <div className="w-16 h-16 bg-white rounded flex items-center justify-center overflow-hidden border border-gray-600 shrink-0">
                                            {p.image ? (<img src={p.image} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} />) : (<span className="text-2xl">üì¶</span>)}
                                        </div>
                                        <div>
                                            <div className="font-bold text-white mb-1 text-sm">{p.name}</div>
                                            <div className="text-xs bg-[#333] px-2 py-1 rounded inline-block font-mono text-gray-400">{p.sku}</div>
                                            {p.lastCheck && <div className="text-[10px] text-gray-500 mt-1">Verificat: {p.lastCheck}</div>}
                                        </div>
                                    </div>
                                </td>
                                <td className="p-4 align-top text-xl font-bold text-gray-500">{p.price} Lei</td>
                                <td className="p-4">
                                    {p.comps && p.comps.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                                            {p.comps.map((c,k) => {
                                                const isCheaper = c.price < p.price || p.price === 0; // Daca pretul nostru e 0, oricum e "mai ieftin" sau relevant
                                                return (
                                                    <div key={k} className={`p-2 rounded border ${isCheaper ? 'bg-red-900/20 border-red-800' : 'bg-green-900/20 border-green-800'} relative`}>
                                                        <div className="absolute -top-2 -right-2 bg-[#333] text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-[#555]">{k+1}</div>
                                                        <div className="font-bold text-xs mb-1 text-gray-400">{c.name}</div>
                                                        <div className={`text-lg font-bold ${isCheaper ? 'text-red-400' : 'text-green-400'}`}>{c.price}</div>
                                                        <a href={c.url} target="_blank" className="text-[10px] text-blue-400 hover:underline block mt-1 truncate">Link ‚Üó</a>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    ) : (
                                        <span className={`text-xs italic ${p.status === 'no_results' ? 'text-red-500 font-bold' : 'text-gray-600'}`}>
                                            {p.status === 'no_results' ? "Niciun rezultat gƒÉsit pe site-urile vizate." : "..."}
                                        </span>
                                    )}
                                </td>
                                <td className="p-4 align-top">
                                    <button onClick={() => check(p.id)} disabled={checkingId === p.id} className="text-blue-400 border border-blue-900/50 hover:bg-blue-900/20 px-3 py-2 rounded w-full transition">
                                        {checkingId === p.id ? '‚è≥' : 'üîç'}
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Dashboard />);
</script></body></html>
