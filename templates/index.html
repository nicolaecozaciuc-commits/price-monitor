<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Price Monitor v10 - Top 5</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f0f0f;color:#e0e0e0;font-family:sans-serif}
.animate-pulse{animation:p 2s infinite}@keyframes p{0%,100%{opacity:1}50%{opacity:.5}}
</style>
</head>
<body><div id="root"></div><script type="text/babel">
const {useState} = React;

const Dashboard = () => {
    const [products, setProducts] = useState([]);
    const [checkingId, setCheckingId] = useState(null);
    const [progress, setProgress] = useState(null);

    const parseCSV = (text) => {
        const rows = []; let cur = []; let cell = ''; let q = false;
        text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('').forEach(c => {
            if(c === '"') q = !q; else if(c === ',' && !q) { cur.push(cell); cell = ''; }
            else if(c === '\n' && !q) { cur.push(cell); rows.push(cur); cur = []; cell = ''; }
            else cell += c;
        });
        if(cell || cur.length) { cur.push(cell); rows.push(cur); }
        return rows;
    };

    const handleUpload = (e) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const rows = parseCSV(evt.target.result);
            if(rows.length < 2) return alert("CSV Invalid");
            const h = rows[0].map(x => x.toLowerCase().replace(/[^a-z0-9]/g, ''));
            
            let iSku = h.findIndex(x => x.includes('sku'));
            let iName = h.findIndex(x => x.includes('nume'));
            let iPrice = h.indexOf('pretnostru');
            if(iPrice === -1) iPrice = h.findIndex(x => x.includes('pretobisnuit') || (x.includes('pret') && !x.includes('concurent')));
            
            if(iSku === -1) return alert("Nu gasesc SKU");
            
            setProducts(rows.slice(1).map((r, k) => {
                if(r.length <= iSku) return null;
                let p = r[iPrice] ? parseFloat(r[iPrice].replace(/\./g,'').replace(',','.')) : 0;
                return {id: k, sku: r[iSku], name: r[iName]||'', price: p, comps: []};
            }).filter(x => x && x.sku));
        };
        reader.readAsText(e.target.files[0]);
    };

    const check = async (id) => {
        const p = products.find(x => x.id === id);
        setCheckingId(id);
        try {
            const res = await fetch('/api/check', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)});
            const d = await res.json();
            if(d.status === 'success') setProducts(prev => prev.map(x => x.id === id ? {...x, comps: d.competitors} : x));
        } catch(e) { console.error(e); }
        finally { setCheckingId(null); }
    };

    const runBulk = () => {
        if(!products.length) return alert("Incarca CSV!");
        if(!confirm("Start scanare TOP 5? (Dureaza ~30s per produs)")) return;
        setProgress({cur:0, tot:products.length});
        let i = 0;
        const next = () => {
            if(i >= products.length) { setProgress(null); return; }
            setProgress({cur:i+1, tot:products.length});
            check(products[i].id).then(() => { i++; setTimeout(next, 2000); });
        };
        next();
    };

    return (
        <div className="p-6 max-w-[95%] mx-auto">
            <div className="bg-[#1a1a1a] p-6 rounded-xl border border-[#333] mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-white flex gap-2"><span>üìä</span> PriceMonitor v10</h1>
                    <p className="text-gray-500 text-sm">Top 5 Competitori (9 Site-uri Scanate)</p>
                </div>
                <div className="flex gap-4">
                    {progress && <span className="text-blue-400 font-mono self-center animate-pulse">Progres: {progress.cur}/{progress.tot}</span>}
                    <button onClick={runBulk} disabled={!!progress} className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-2 rounded text-white font-bold hover:opacity-90 disabled:opacity-50">üöÄ Start Scanare</button>
                    <label className="bg-[#333] px-4 py-2 rounded cursor-pointer hover:bg-[#444] text-white">
                        üìÇ CSV <input type="file" onChange={handleUpload} className="hidden"/>
                    </label>
                </div>
            </div>

            <div className="bg-[#1a1a1a] rounded-xl border border-[#333] overflow-hidden">
                <table className="w-full text-left text-sm text-gray-300">
                    <thead className="bg-black text-gray-500 uppercase"><tr><th className="p-4 w-1/4">Produs</th><th className="p-4 w-32">Pre»õul TƒÉu</th><th className="p-4">Top 5 Competitori (Cel mai mic pre»õ)</th><th className="p-4 w-24">Ac»õiuni</th></tr></thead>
                    <tbody className="divide-y divide-[#2a2a2a]">
                        {products.map(p => (
                            <tr key={p.id} className="hover:bg-[#222]">
                                <td className="p-4 align-top">
                                    <div className="font-bold text-white mb-1">{p.name}</div>
                                    <div className="text-xs bg-[#333] px-2 py-1 rounded inline-block font-mono text-gray-400">{p.sku}</div>
                                </td>
                                <td className="p-4 align-top text-xl font-bold text-emerald-400">{p.price} Lei</td>
                                <td className="p-4">
                                    {p.comps && p.comps.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                                            {p.comps.map((c,k) => {
                                                const isCheaper = c.price < p.price;
                                                return (
                                                    <div key={k} className={`p-2 rounded border ${isCheaper ? 'bg-red-900/20 border-red-800' : 'bg-green-900/20 border-green-800'} relative`}>
                                                        <div className="absolute -top-2 -right-2 bg-[#333] text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-[#555]">{k+1}</div>
                                                        <div className="font-bold text-xs mb-1 text-gray-400">{c.name}</div>
                                                        <div className={`text-lg font-bold ${isCheaper ? 'text-red-400' : 'text-green-400'}`}>{c.price}</div>
                                                        <a href={c.url} target="_blank" className="text-[10px] text-blue-400 hover:underline block mt-1 truncate">Vezi produs ‚Üó</a>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    ) : <span className="text-gray-600 italic text-xs">A»ôteaptƒÉ scanarea...</span>}
                                </td>
                                <td className="p-4 align-top">
                                    <button onClick={() => check(p.id)} disabled={checkingId === p.id} 
                                        className="text-blue-400 border border-blue-900/50 hover:bg-blue-900/20 px-3 py-2 rounded w-full transition">
                                        {checkingId === p.id ? '‚è≥' : 'üîç'}
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Dashboard />);
</script></body></html>
